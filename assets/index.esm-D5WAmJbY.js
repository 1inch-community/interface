import{_ as Q}from"./index-w6Xy5dA-.js";import{aj as C,ak as X,n as H,a8 as y,L as G,a2 as g,al as B,am as z,j as K,s as J,c as _,h as N,f as W,an as Y,ao as tt}from"./index.esm-D_9Ml8zN.js";import{C as o,s as et}from"./index.esm-DhwY4kHm.js";import{C as F}from"./index.esm-BcUoR516.js";import{l as at}from"./import-wrapper-prod-BvIURD_x.js";import{storage as w,JsonParser as v}from"./index.esm-COc-PyqV.js";import{d as st}from"./defer-BRewiDsk.js";const p="0x0000000000000000000000000000000000000000";var T=class{constructor(){throw new Error("BigMath does not support instance creation. Use static methods: div, mul, add, sub, avr, pow, min, max.")}static from(t,e){return BigInt(t*10**e)}static div(t,e,a,s,n=s){if(e===0n)throw new Error("Division by zero.");if(t===0n)return 0n;const r=BigInt(10)**BigInt(Math.max(a,s));t=t*(r/BigInt(10)**BigInt(a)),e=e*(r/BigInt(10)**BigInt(s));const i=BigInt(10)**BigInt(n);return t=t*i,t/e}static mul(t,e,a,s,n=s){if(t===0n||e===0n)return 0n;const r=t*e,c=10n**BigInt(a+s),l=10n**BigInt(n);return r*l/c}static add(t,e,a,s,n=s){const r=Math.max(a,s,n);t=t*BigInt(10)**BigInt(r-a),e=e*BigInt(10)**BigInt(r-s);const i=t+e;return n<r?i/BigInt(10)**BigInt(r-n):i}static sub(t,e,a,s,n=s){const r=Math.max(a,s,n);t=t*BigInt(10)**BigInt(r-a),e=e*BigInt(10)**BigInt(r-s);const i=t-e;return n<r?i/BigInt(10)**BigInt(r-n):i}static avr(t,e,a=e){if(t.length===0)return 0n;const s=BigInt(10)**BigInt(a);return t.map(i=>i*s/BigInt(10)**BigInt(e)).reduce((i,c)=>i+c,BigInt(0))/BigInt(t.length)}static pow(t,e,a,s=a){if(e<0)throw new Error("Negative exponents are not supported.");if(e===0)return BigInt(10)**BigInt(s);const n=BigInt(10)**BigInt(a);let i=(t*n)**BigInt(e);const c=BigInt(10)**BigInt(e*a);if(i=i/c,s!==a){const l=BigInt(10)**BigInt(s-a);i=i*l}return i}static min(...t){let e=t[0];for(const a of t)a<e&&(e=a);return e}static max(...t){let e=t[0];for(const a of t)a>e&&(e=a);return e}static calculatePercentage(t,e){if(e<0||e>100)throw new Error("Percentage must be a number between 0 and 100");const a=e/100;return t*BigInt(a*1e32)/BigInt(1e32)}},nt=Object.defineProperty,rt=Object.getOwnPropertyDescriptor,D=(t,e,a,s)=>{for(var n=rt(e,a),r=t.length-1,i;r>=0;r--)(i=t[r])&&(n=i(e,a,n)||n);return n&&nt(e,a,n),n},j=C(["function getPair(address tokenA, address tokenB) external view returns (address pair)"]),M=C(["function getReserves() external view returns (uint112 reserve0, uint112 reserve1, uint32 blockTimestampLast)","function token0() external view returns (address)","function token1() external view returns (address)"]),R=class{constructor(t,e,a){this.name=t,this.factoryContractGetter=e,this.supportedChain=a,this.pools=new G(`${this.name}_pools`,7)}isSupportedChain(t){return this.supportedChain.includes(t)}async getRate(t,e,a){try{const s=g(e.address),n=g(a.address),[r,i]=await this.getPool(t,s,n);if(r===p)return null;const c=await this.getReserves(t,r),l=c[2];if(Date.now()-l*1e3>36e5)return null;const u=!y(e.address,i),d=T.div(u?c[0]:c[1],u?c[1]:c[0],a.decimals,e.decimals,e.decimals),h=T.div(u?c[1]:c[0],u?c[0]:c[1],e.decimals,a.decimals,a.decimals);return{chainId:t,rate:d,revertedRate:h,isReverted:u,sourceToken:e,destinationToken:a}}catch(s){return console.error(`Error in UniswapV2BaseAdapter adapter name ${this.name}`,s),null}}async getPool(t,e,a){const s=[t,e,a].join(":");if(this.pools.has(s))return this.pools.get(s);const n=[t,a,e].join(":");if(this.pools.has(n))return this.pools.get(n);const r=B(t);let i=await r.readContract({address:g(this.factoryContractGetter(t)),functionName:"getPair",args:[e,a],abi:j});i!==p&&(i=await r.readContract({address:g(this.factoryContractGetter(t)),functionName:"getPair",args:[a,e],abi:j}));let c=p;return i!==p&&(c=await r.readContract({address:i,abi:M,functionName:"token0"})),this.pools.set(s,[i,c]),this.pools.set(n,[i,c]),[i,c]}async getReserves(t,e){return await B(t).readContract({address:e,abi:M,functionName:"getReserves"})}},it=new R("UniswapV2",()=>"0x5C69bEe701ef814a2B6a3EDD4B1652CB9cc5aA6f",[o.eth,o.bnb,o.matic,o.op,o.arbitrum,o.avalanche]),ot={[o.eth]:"0xC0AeE478e3658e2610c5F7A4A2E1777cE9e4f2Ac",[o.bnb]:"0xc35dadb65012ec5796536bd9864ed8773abc74c4",[o.matic]:"0xc35dadb65012ec5796536bd9864ed8773abc74c4",[o.gnosis]:"0xc35dadb65012ec5796536bd9864ed8773abc74c4",[o.fantom]:"0xc35dadb65012ec5796536bd9864ed8773abc74c4",[o.avalanche]:"0xc35dadb65012ec5796536bd9864ed8773abc74c4",[o.arbitrum]:"0xc35dadb65012ec5796536bd9864ed8773abc74c4"},ct=new R("SushiSwapV2",t=>ot[t],[o.eth,o.bnb,o.matic,o.gnosis,o.fantom,o.arbitrum,o.avalanche]),dt={[o.eth]:"0x1097053Fd2ea711dad45caCcc45EfF7548fCB362",[o.bnb]:"0xcA143Ce32Fe78f1f7019d7d551a6402fC5350c73",[o.arbitrum]:"0x02a84c1b3BBD7401a5f7fa98a384EBC70bB5749E"},ut=new R("PancakeSwapV2",t=>dt[t],[o.eth,o.bnb,o.arbitrum]),lt=C(["function getPool(address tokenA, address tokenB, uint24 fee) external view returns (address pool)"]),P=C(["function liquidity() external view returns (uint128)","function slot0() external view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)","function token0() external view returns (address)","function token1() external view returns (address)"]),S=class{constructor(t,e,a,s){this.name=t,this.factoryContractGetter=e,this.supportedChain=a,this.feeTiers=s,this.pools=new G(`${this.name}_pools`,7),this.liquidityCache=new z}isSupportedChain(t){return this.supportedChain.includes(t)}async getRate(t,e,a){try{const s=g(e.address),n=g(a.address),[r,i]=await this.getPool(t,s,n);if(r===p)return null;const c=!y(e.address,i),[l,u]=await Promise.all([this.getSqrtPriceX96(t,r),this.getLiquidity(t,r)]),[d,h]=this.calculatePrice(l,e,a,u,c);return{chainId:t,rate:d,revertedRate:h,sourceToken:e,destinationToken:a,isReverted:c}}catch(s){return console.error(`Error in UniswapV3BaseRateAdapter adapter name ${this.name}`,s),null}}async getPool(t,e,a){const s=[t,e,a].join(":");if(this.pools.has(s))return this.pools.get(s);const n=[t,a,e].join(":");if(this.pools.has(n))return this.pools.get(n);const r=B(t);let i=p,c=0n;for(const l of this.feeTiers){const u=await r.readContract({address:g(this.factoryContractGetter(t)),functionName:"getPool",args:[e,a,l],abi:lt});if(u===p)continue;const d=await this.getLiquidity(t,u);d>c&&(c=d,i=u)}if(i!==p){const l=await r.readContract({address:i,abi:P,functionName:"token0"});return this.pools.set(s,[i,l]),this.pools.set(n,[i,l]),[i,l]}return[p,p]}async getSqrtPriceX96(t,e){const a=B(t),[s]=await a.readContract({address:e,abi:P,functionName:"slot0"});return s}async getLiquidity(t,e){const a=this.liquidityCache.get(t,e);if(a)return a;const n=await B(t).readContract({address:e,functionName:"liquidity",abi:P});return this.liquidityCache.set(t,e,n),n}calculatePrice(t,e,a,s,n){const r=2n**96n,i=s*r/t,c=s*t/r;return[T.div(n?i:c,n?c:i,a.decimals,e.decimals,e.decimals),T.div(n?c:i,n?i:c,e.decimals,a.decimals,a.decimals)]}};function ht(t){return t===o.bnb?"0xdB1d10011AD0Ff90774D0C6Bb92e5C5c8b4461F7":t===o.avalanche?"0x740b1c1de25031C31FF4fC9A62f554A55cdC1baD":"0x1F98431c8aD98523631AE4a59f267346ea31F984"}var pt=new S("UniswapV3",ht,[o.eth,o.bnb,o.matic,o.op,o.arbitrum,o.avalanche],[100,500,3e3,1e4]);function ft(t){return t===o.zkSyncEra?"0x1BB72E0CbbEA93c08f535fc7856E0338D7F7a8aB":"0x0BFbCF9fa4f9C56B0F40a671Ad40E0805A091865"}var gt=new S("PancakeSwapV3",ft,[o.eth,o.bnb,o.arbitrum,o.zkSyncEra],[100,500,2500,1e4]),bt={[o.eth]:"0xbACEB8eC6b9355Dfc0269C18bac9d6E2Bdc29C4F",[o.bnb]:"0x126555dd55a39328F69400d6aE4F782Bd4C34ABb",[o.matic]:"0x917933899c6a5F8E37F31E19f92CdBFF7e8FF0e2",[o.gnosis]:"0xf78031CBCA409F2FB6876BDFDBc1b2df24cF9bEf",[o.fantom]:"0x7770978eED668a3ba661d51a773d3a992Fc9DDCB",[o.avalanche]:"0x3e603C14aF37EBdaD31709C4f848Fc6aD5BEc715",[o.arbitrum]:"0x1af415a1EbA07a4986a52B6f2e7dE7003D82231e",[o.op]:"0x9c6522117e2ed1fE5bdb72bb0eD5E3f2bdE7DBe0"},mt=new S("SushiSwapV3",t=>bt[t],[o.eth,o.bnb,o.op,o.matic,o.gnosis,o.fantom,o.arbitrum,o.avalanche],[100,500,3e3,1e4]),wt=new S("SpookySwapV3",()=>"0x7928a2c48754501f3a8064765ECaE541daE5c3E6",[o.fantom],[100,500,3e3,1e4]),U=class{constructor(t){this.onChainAdapters=t,this.rateCache=new z}async getOnChainRate(t,e,a){const s=await this.getOnChainRawRate(t,e,a);if(s.length===0)return null;const n=i=>i.isReverted?i.revertedRate:i.rate;let r=s[0];for(const i of s)n(i)>n(r)&&(r=i);return r}listenOnChainRate(t,e,a){return K(t).pipe(et(null),J(()=>this.getOnChainRate(t,e,a)))}async getOnChainRawRate(t,e,a){let s=e,n=a;if(_(e.address)){const d=N(t);if(!d)return[];s=d}if(_(a.address)){const d=N(t);if(!d)return[];n=d}const r=[s.address,n.address].join(":"),i=this.rateCache.get(t,r);if(i!==null)return i;const c=this.onChainAdapters.filter(d=>d.isSupportedChain(t)),u=(await Promise.all(c.map(d=>d.getRate(t,s,n)))).filter(d=>d!==null);return this.rateCache.set(t,r,u),u}};D([F((t,e,a,s)=>[e,a.address,s.address].join(":"))],U.prototype,"getOnChainRate");function Z(){return new U([pt,gt,mt,wt,it,ct,ut])}var kt={[o.eth]:"0xdac17f958d2ee523a2206206994597c13d831ec7",[o.bnb]:"0x55d398326f99059ff775485246999027b3197955",[o.matic]:"0xc2132d05d31c914a87c6611c10748aeb04b58e8f",[o.op]:"0x94b008aa00579c1307b0ef2c499ad98a8ce58e58",[o.arbitrum]:"0xfd086bc7cd5c481dcc9c85ebe478a1c0b69fcbb9",[o.gnosis]:"0x4ecaba5870353805a9f068101a40e0f32ed605c6",[o.avalanche]:"0xc7198437980c041c805a1edcba50c1ce5db95118",[o.fantom]:"0xcc1b99ddac1a33c201a742a1851662e87bc7f22c",[o.aurora]:"0x4988a896b1227218e4a686fde5eabdcabd91571f",[o.klaytn]:"0x754288077d0ff82af7a5317c7cb8c444d421d103",[o.zkSyncEra]:"0x493257fd37edb34451f62edf8d2a0c418852ba4c"},yt=6,$=class{constructor(){this.rateProvider=Z()}async getPrice(t,e){const a=kt[t];if(y(e.address,a))return"1";const s=await this.rateProvider.getOnChainRate(t,{address:a,chainId:t,decimals:yt,name:"USDT",symbol:"USDT"},e);return s?W(s.rate,e.decimals):"0"}},O={native:1e3,USDT:100,USDC:100,WETH:62,"1INCH":61,"PEG:ETH":60,"PEG:USD":50,"PEG:BTC":40,"PEG:EUR":30,staking:20,savings:10,tokens:0},b,L=(b=class{constructor(){this.tokenCache=new X(50)}get tokens(){if(!this.database)throw new Error("token database not init");return this.database.tokens}get balances(){if(!this.database)throw new Error("token database not init");return this.database.balances}async init(){const e=await Q(()=>import("./import-wrapper-prod-BvIURD_x.js").then(s=>s.i),[]).then(s=>s.Dexie),a=new e("one-inch-token");a.version(b.databaseVersion).stores({tokens:["id","address","decimals","chainId","name","symbol","*tags","eip2612","logoURL","isFavorite","priority"].join(", "),balances:["id","chainId","tokenAddress","walletAddress","amount"].join(", ")}),this.database=a}async getToken(e,a){const s=k(e,a);if(this.tokenCache.has(s))return this.tokenCache.get(s);const n=await this.tokens.where("id").equals(s).toArray();return this.tokenCache.set(s,n[0]),n[0]??null}async getNativeToken(e){return this.getToken(e,H)}getTokenBySymbol(e,a){return this.tokens.where("chainId").equals(e).filter(s=>s.symbol===a).toArray()}async getTokenMap(e,a){const s=new Set(a),n={};return await this.tokens.each(r=>{r.chainId===e&&s.has(r.address)&&(n[r.address]=r)}),n}getTokenList(e,a){const s=new Set(a);return this.tokens.filter(n=>n.chainId===e&&s.has(n.address)).toArray()}async getTokenBalanceMap(e,a,s){const n=new Set(s),r={};return await this.balances.each(i=>{i.chainId===e&&i.walletAddress===a&&n.has(i.tokenAddress)&&(r[i.tokenAddress]=BigInt(i.amount))}),r}async getTokens(e,a){const s=new Set(a);return this.tokens.filter(n=>n.chainId===e&&s.has(n.address)).toArray()}async getAllTokenAddresses(e){const a=[];return await this.tokens.where("chainId").equals(e).each(s=>a.push(s.address)),a}async getTokenBalance(e,a,s){const n=k(e,s,a);return(await this.balances.where("id").equals(n).toArray())[0]??null}async isEmptyTokenBalanceStorage(e,a){return this.balances.filter(s=>s.chainId===e&&y(s.walletAddress,a)).toArray().then(s=>s.length===0)}async setTokens(e,a){var n;const s=[];for(const r of a)s.push({id:k(e,r.address),address:r.address,decimals:r.decimals,eip2612:((n=r.extensions)==null?void 0:n.eip2612)??null,name:r.name,symbol:r.symbol,tags:r.tags,logoURL:r.logoURI,isFavorite:!1,chainId:e,priority:Bt(r)});this.tokenCache.clear(),await this.tokens.bulkPut(s)}async setBalances(e,a,s){const n=[];for(const r in s){const i=r;n.push({id:k(e,a,i),chainId:e,tokenAddress:i,walletAddress:a,amount:s[i]})}await this.balances.bulkPut(n)}async getAllFavoriteTokenAddresses(e){const a=[];return await this.tokens.where("chainId").equals(e).each(s=>{s.isFavorite&&a.push(s.address)}),a}async getSortedByPriorityAndBalanceTokenAddresses(e,a,s){const n={},r={},i=new Set,c=[],l=[],u=a.toLowerCase();return s&&await this.balances.where("chainId").equals(e).and(d=>y(d.walletAddress,s)).each(d=>n[d.tokenAddress]=BigInt(d.amount)),await this.tokens.where("chainId").equals(e).each(d=>{if(!(u!==""&&!d.address.toLowerCase().includes(u)&&!d.name.toLowerCase().startsWith(u)&&!d.symbol.toLowerCase().startsWith(u))){if(n[d.address]&&n[d.address]>0n){c.push(d.address);return}r[d.address]=d.priority,l.push(d.address),d.isFavorite&&i.add(d.address)}}),{notZero:c,zero:l.sort((d,h)=>{const f=r[d],m=r[h],q=i.has(d),V=i.has(h);return q===V?f<m?1:f>m?-1:0:q?-1:V?1:0})}}async setFavoriteState(e,a,s){const n=k(e,a);this.tokenCache.delete(n),await this.tokens.update(n,{isFavorite:s})}async setEip2612Support(e,a,s){const n=k(e,a);await this.tokens.update(n,{eip2612:s})}},b.databaseVersion=4,b);function k(...t){return t.join(":")}function Bt(t){var a;let e=((a=t.providers)==null?void 0:a.length)??0;e+=O[t.symbol]??0;for(const s of t.tags)e+=O[s]??0;return e}var vt={[o.eth]:11e3,[o.bnb]:3e3,[o.matic]:3e3,[o.op]:3e3,[o.arbitrum]:3e3,[o.gnosis]:5e3,[o.avalanche]:3e3,[o.fantom]:3e3,[o.aurora]:3e3,[o.klaytn]:3e3,[o.zkSyncEra]:3e3},E=`last-update-token-database-timestamp-v${L.databaseVersion}`,x=`last-update-token-balance-database-timestamp-v${L.databaseVersion}`,Tt=6048e5,Ct=vt,I=class{constructor(){this.schema=new L,this.tokenUsdPriceProvider=new $,this.lastUpdateTokenDatabaseTimestampStorage=w.get(E,v),this.lastUpdateTokenBalanceDatabaseTimestampStorage=w.get(x,v)}async init(t){this.context=t,this.oneInchApiAdapter=t.oneInchDevPortalAdapter,await this.schema.init()}async getSortedByPriorityAndBalanceTokenAddresses(t,e,a){await this.updateTokenDatabase(t),a&&await this.updateBalanceDatabase(t,a);const s=await this.schema.getSortedByPriorityAndBalanceTokenAddresses(t,e,a);if(a){const n=await this.getTokenUSDPrices(t,s.notZero),r=await this.getTokenMap(t,s.notZero),i=await this.getTokenBalanceMap(t,a,s.notZero),c=await this.getAllFavoriteTokenAddresses(t),l=new Set(c),u={};for(const d of s.notZero){const h=r[d],f=n[d],m=W(i[d],h.decimals);u[d]=Number(m)*Number(f)}return[...s.notZero.sort((d,h)=>{const f=l.has(d),m=l.has(h);return f===m?u[h]-u[d]:f?-1:1}),...s.zero]}return[...s.notZero,...s.zero]}async getToken(t,e){return await this.updateTokenDatabase(t),await this.schema.getToken(t,e)}async getNativeToken(t){return await this.updateTokenDatabase(t),await this.schema.getNativeToken(t)}async getTokenBySymbol(t,e){return await this.updateTokenDatabase(t),this.schema.getTokenBySymbol(t,e)}async getTokenList(t,e){return await this.updateTokenDatabase(t),await this.schema.getTokenList(t,e)}async getTokenListSortedByPriority(t,e){return(await this.getTokenList(t,e)).sort((s,n)=>n.priority-s.priority)}async getTokenMap(t,e){return await this.schema.getTokenMap(t,e)}async getTokenBalanceMap(t,e,a){return await this.updateBalanceDatabase(t,e),await this.schema.getTokenBalanceMap(t,e,a)}async getTokenBalance(t,e,a){return await this.updateBalanceDatabase(t,a,e),await this.schema.getTokenBalance(t,e,a)}async getTokenUSDPrice(t,e){return(await this.getTokenUSDPrices(t,[e]))[e]}async isFavoriteToken(t,e){const a=await this.getToken(t,e);return(a==null?void 0:a.isFavorite)??!1}async getTokenLogoURL(t,e){const a=await this.getToken(t,e);return(a==null?void 0:a.logoURL)??null}async getPriorityToken(t,e){const a=await this.getTokenList(t,e),s=n=>n.tags.includes("PEG:USD")||n.tags.includes("PEG:EUR");return a.sort((n,r)=>{const i=s(n),c=s(r);return i&&c?n.priority-r.priority:i&&!c?-1:!i&&c?1:n.priority-r.priority})[0]}async setFavoriteState(t,e,a){await this.schema.setFavoriteState(t,e,a)}async getAllFavoriteTokenAddresses(t){return await this.schema.getAllFavoriteTokenAddresses(t)}async getTokenUSDPrices(t,e){const a={},s=await this.oneInchApiAdapter.getTokenPrices(t).catch(()=>null);if(s===null){const n=await this.schema.getTokens(t,e);return await Promise.all(n.map(r=>this.tokenUsdPriceProvider.getPrice(t,r).catch(()=>"0").then(i=>a[r.address]=i))),a}for(const n of e)a[n]=s[n]??"0";return a}async isSupportedTokenPermit(t,e){const a=await this.schema.getToken(t,e);if(!a)return!1;if(a.eip2612===null){const s=await Y(t,e);return await this.schema.setEip2612Support(t,e,s),s}return a.eip2612}async updateTokenDatabase(t){var s;const e=(s=this.lastUpdateTokenDatabaseTimestampStorage)==null?void 0:s[t];if(e&&Date.now()-e<Tt)return;const a=await this.oneInchApiAdapter.getWhiteListedTokens(t);await this.schema.setTokens(t,a),w.updateEntity(E,t.toString(),Date.now()),this.lastUpdateTokenDatabaseTimestampStorage=w.get(E,v)}async updateBalanceDatabase(t,e,a){var i;const s=[t,e].join(":"),n=(i=this.lastUpdateTokenBalanceDatabaseTimestampStorage)==null?void 0:i[s];if(n&&Date.now()-n<Ct[t])return;const r=async()=>{let c=await this.oneInchApiAdapter.getBalancesByWalletAddress(t,e).catch(()=>null);c===null&&(c=await this.getBalancesOnChain(t,e)),await this.schema.setBalances(t,e,c),w.updateEntity(x,s,Date.now()),this.lastUpdateTokenBalanceDatabaseTimestampStorage=w.get(x,v)};if(a){if(await this.schema.getTokenBalance(t,a,e)===null)return await r()}else if(await this.schema.isEmptyTokenBalanceStorage(t,e))return await r();r().catch(c=>console.error(c))}liveQuery(t){return st(()=>at(t))}async getBalancesOnChain(t,e){const a=await this.schema.getAllTokenAddresses(t);return tt(t,e,a)}};D([F()],I.prototype,"updateTokenDatabase");D([F()],I.prototype,"updateBalanceDatabase");function A(t,e){const a=y(t.address,e.address),s=t.chainId===e.chainId;return a&&s}function St(t,e){return t.rate===e.rate&&t.chainId===e.chainId&&t.revertedRate===e.revertedRate&&A(t.sourceToken,e.sourceToken)&&A(t.destinationToken,e.destinationToken)}const Ut=Object.freeze(Object.defineProperty({__proto__:null,TokenController:I,TokenRateProvider:U,TokenUsdOnChainPriceProvider:$,buildDefaultTokenRateProvider:Z,isRateEqual:St,isTokensEqual:A},Symbol.toStringTag,{value:"Module"}));export{T as B,St as a,Ut as b,A as i};
//# sourceMappingURL=index.esm-D5WAmJbY.js.map
